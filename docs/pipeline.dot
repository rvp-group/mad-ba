digraph{
    
    compound=true;

    subgraph cluster_1 {
    node [style=filled, color="#ffbb00"];
    gen_odom [label="Generate odometry"] 
    handle_odom [label="Handle odometry\n(save pose)"]
    gen_pointcloud [label="Generate point cloud\n for given pose"]
    add_pointcloud_noise [label = "Add noise to point cloud" shape=rectangle color="#ff6c02"]
    handle_pointcloud [label="Handle point cloud\n (Extract surfels, save cloud)"]
    add_noise_to_poses [label="Add noise to poses\n (for algorithm validation)", shape=rectangle, color="#ff6c02"] 
    gen_odom -> handle_odom -> gen_pointcloud -> add_pointcloud_noise -> add_noise_to_poses -> handle_pointcloud 
     gen_odom
    }

    subgraph cluster_2{
    node [style=filled, color="#00ffbf"];
    publish_cloud [label="Publish clouds in\n each pose's frame"]
    publish_tf [label="Publish TF based\n on graph estimates"]
    create_graph [label="Create graph"]
    add_noise_to_estimates[label="Add noise to graph estimates\n (for visualization)", shape=rectangle, color="#9090f5"]
    optimize_poses [label="Optimize poses"]
    publish_cloud_after [label = "Publish clouds in\n each pose's frame"]
    publish_tf_after [label="Publish TF for each pose"]
    create_graph  -> add_noise_to_estimates -> publish_cloud -> publish_tf -> optimize_poses -> publish_cloud_after -> publish_tf_after
    }

    subgraph cluster_3{
    node [style=filled, color="#a6ff00"];
    associate_surfels [label="Find correspondences\n for each surfel"]
    store_surfel [label = "For each surfel store\n indices of poses, indices of surfels\n in given trees, and observations\n (including poses with noise)"] 
    associate_surfels -> store_surfel
    }

    handle_pointcloud -> associate_surfels
    store_surfel -> create_graph
    "Remarks:\n 
    - point clouds are stored in local coordinate frame\n
    - surfels are stored in the global coordinate frame\n"
}